<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÿÆÿ±Ÿäÿ∑ÿ© ŸÖÿµÿßŸÜÿπ ÿßŸÑŸÖÿ¨ŸÖÿπ ÿßŸÑŸÉŸäŸÖŸäÿßÿ¶Ÿä ÿßŸÑÿ™ŸàŸÜÿ≥Ÿä ÿ®ŸÇÿßÿ®ÿ≥</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&family=Noto+Sans+Arabic:wght@100;200;300;400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      background: #f5f8fa; 
      margin: 0; 
      padding: 0;
      overflow-x: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* Enhanced Dashboard Container - Same as emissions dashboard */
    .map-article-block {
      max-width: 1400px;
      margin: 20px auto;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(52, 152, 219, 0.15);
      min-width: 0;
    }
    
    /* Enhanced Header with Dashboard Style */
    .map-header {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 30px 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .map-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(255,255,255,0.05) 10px,
        rgba(255,255,255,0.05) 20px
      );
      animation: movePattern 20s linear infinite;
    }
    
    @keyframes movePattern {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    .header-content {
      position: relative;
      z-index: 2;
    }
    
    .map-header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .map-header .subtitle {
      font-size: 1rem;
      opacity: 0.9;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    /* Interactive Instruction */
    .interaction-hint {
      background: rgba(255,255,255,0.15);
      padding: 12px 20px;
      border-radius: 25px;
      font-size: 0.9rem;
      margin-top: 15px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      display: inline-block;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.05); opacity: 1; }
    }

    /* Stats row like dashboard */
    .stats-row {
      display: flex;
      justify-content: space-around;
      gap: 20px;
      margin-top: 20px;
    }
    
    .stat-item {
      text-align: center;
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
      min-width: 120px;
      animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    .map-container {
      position: relative;
      background: linear-gradient(135deg, #f0f9fc 0%, #e8f4f8 100%);
      padding: 30px;
      min-height: 700px;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 650px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(52, 152, 219, 0.15);
      border: 3px solid rgba(52, 152, 219, 0.2);
      z-index: 1;
    }

    /* Enhanced Factory Markers with Dashboard Style - FIXED HOVER CIRCLES */
    .factory-marker-custom {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      border: 4px solid #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 22px;
      box-shadow: 0 10px 25px rgba(52, 152, 219, 0.4);
      cursor: pointer;
      transition: all 0.4s ease;
      font-family: 'Inter', sans-serif;
      position: relative;
      overflow: visible;
    }

    /* FIXED: Removed problematic hover circles and shimmer effect */
    .factory-marker-custom::after {
      content: 'üëÜ ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ŸÅÿßÿµŸäŸÑ';
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: #3498db;
      color: white;
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 10px;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
    }

    .factory-marker-custom:hover {
      transform: translateY(-5px) scale(1.1);
      box-shadow: 0 15px 35px rgba(52, 152, 219, 0.6);
      border-color: #2980b9;
      background: linear-gradient(135deg, #2980b9, #1e5f73);
    }

    .factory-marker-custom:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* SMALLER Map Controls */
    .map-controls {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-button {
      background: #f8f9fa;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 8px 12px; /* REDUCED from 15px 20px */
      font-family: 'Inter', 'Tajawal', sans-serif;
      font-size: 0.85em; /* REDUCED from 1em */
      font-weight: 600;
      color: #2c3e50;
      cursor: pointer;
      transition: all 0.4s ease;
      box-shadow: 0 3px 10px rgba(52, 152, 219, 0.1);
      min-width: 120px; /* REDUCED from 160px */
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .control-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .control-button:hover {
      transform: translateY(-2px); /* REDUCED from -3px */
      box-shadow: 0 6px 15px rgba(52, 152, 219, 0.2);
      border-color: rgba(52, 152, 219, 0.3);
      background: #ffffff;
    }

    .control-button:hover::before {
      left: 100%;
    }

    .control-button.active {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: #fff;
      border-color: #2980b9;
      box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
    }

    .control-button i {
      margin-left: 8px; /* REDUCED from 12px */
      font-size: 1em; /* REDUCED from 1.1em */
    }

    /* Enhanced Popup with Dashboard Modal Style */
    .leaflet-popup-content-wrapper {
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 3px solid rgba(52, 152, 219, 0.2);
      padding: 0;
      overflow: hidden;
    }

    .leaflet-popup-content {
      margin: 0;
      width: 400px !important;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .factory-popup {
      padding: 0;
      text-align: right;
      direction: rtl;
    }

    /* Popup Header with Dashboard Style */
    .popup-header {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 25px;
      text-align: center;
      position: relative;
    }

    .popup-icon {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin: 0 auto 15px;
      backdrop-filter: blur(10px);
    }

    .factory-year {
      background: rgba(255,255,255,0.9);
      color: #3498db;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 700;
      display: inline-block;
      margin-bottom: 10px;
    }

    .factory-name {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 5px;
      line-height: 1.4;
    }

    .factory-subtitle {
      font-size: 1rem;
      opacity: 0.9;
    }

    /* Popup Content */
    .popup-content {
      padding: 25px;
    }

    .production-section {
      margin-top: 0;
    }

    .production-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
    }

    /* Enhanced Production Items WITHOUT Progress Bars */
    .production-item {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 5px solid #3498db;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .production-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .production-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.15);
      background: #ffffff;
      border-left-color: #2980b9;
    }

    .production-item:hover::before {
      left: 100%;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .material-name {
      color: #2c3e50;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .capacity {
      color: #3498db;
      font-weight: 700;
      font-size: 1.2rem;
    }

    /* Info Section like Dashboard */
    .map-footer {
      background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
      padding: 25px;
      border-top: none;
      color: #2c3e50;
      font-size: 1rem;
      text-align: center;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 500;
    }

    /* Loading Indicator Enhancement */
    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.98);
      padding: 32px 40px;
      border-radius: 20px;
      box-shadow: 0 15px 50px rgba(52, 152, 219, 0.3);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #2c3e50;
      z-index: 2000;
      text-align: center;
      border: 3px solid rgba(52, 152, 219, 0.2);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e9ecef;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Enhanced Industry Info */
    .industry-info {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.97);
      border: 3px solid rgba(52, 152, 219, 0.2);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
      backdrop-filter: blur(25px);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: right;
      direction: rtl;
      z-index: 1000;
      max-width: 240px;
      transition: all 0.3s ease;
    }

    .industry-info:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(52, 152, 219, 0.25);
    }

    .industry-title {
      font-size: 1.1em;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 12px;
    }

    .industry-desc {
      font-size: 0.9em;
      color: #34495e;
      line-height: 1.6;
      font-weight: 500;
    }

    /* Fade-in Animation */
    .fade-in {
      animation: fadeIn 0.8s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Enhanced Mobile Responsiveness */
    @media (max-width: 768px) {
      .map-article-block {
        margin: 10px;
        border-radius: 8px;
      }
      
      .map-header {
        padding: 25px 15px;
      }
      
      .map-header h1 {
        font-size: 1.5rem;
      }
      
      .map-header .subtitle {
        font-size: 0.9rem;
      }

      .stats-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .map-container {
        padding: 15px;
        min-height: 500px;
      }
      
      #map {
        height: 450px;
      }
      
      .map-controls {
        top: 10px;
        left: 10px;
        flex-direction: row;
        gap: 6px;
        flex-wrap: wrap;
      }
      
      .control-button {
        padding: 6px 10px; /* FURTHER REDUCED for mobile */
        font-size: 0.75em;
        min-width: 90px; /* FURTHER REDUCED for mobile */
      }
      
      .factory-marker-custom {
        width: 50px;
        height: 50px;
        font-size: 18px;
      }
      
      .leaflet-popup-content {
        width: 320px !important;
      }
      
      .industry-info {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .map-header h1 {
        font-size: 1.3rem;
      }
      
      .map-container {
        padding: 10px;
      }
      
      #map {
        height: 400px;
      }
      
      .control-button {
        padding: 5px 8px; /* SMALLEST for very small screens */
        font-size: 0.7em;
        min-width: 80px;
      }
      
      .factory-marker-custom {
        width: 44px;
        height: 44px;
        font-size: 16px;
      }
      
      .leaflet-popup-content {
        width: 280px !important;
      }
      
      .popup-header {
        padding: 20px 15px;
      }
      
      .popup-content {
        padding: 20px 15px;
      }
    }

    /* Enhanced Leaflet Controls */
    .leaflet-control-zoom {
      border: 3px solid rgba(52, 152, 219, 0.2) !important;
      border-radius: 12px !important;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.2) !important;
    }

    .leaflet-control-zoom a {
      background: rgba(255,255,255,0.95) !important;
      color: #3498db !important;
      font-weight: bold !important;
      font-size: 18px !important;
      border: none !important;
      transition: all 0.3s ease !important;
    }

    .leaflet-control-zoom a:hover {
      background: #3498db !important;
      color: white !important;
      transform: scale(1.05);
    }

    /* Custom popup close button */
    .leaflet-popup-close-button {
      color: white !important;
      font-size: 20px !important;
      font-weight: bold !important;
      right: 15px !important;
      top: 15px !important;
      background: rgba(255,255,255,0.2) !important;
      border-radius: 50% !important;
      width: 30px !important;
      height: 30px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: all 0.3s ease !important;
    }

    .leaflet-popup-close-button:hover {
      background: rgba(255,255,255,0.3) !important;
      transform: rotate(90deg) !important;
    }

    .leaflet-popup-tip {
      background: white;
      border: 3px solid rgba(52, 152, 219, 0.2);
    }
  </style>
</head>
<body>
  <div class="map-article-block fade-in">
    <div class="map-header">
      <div class="header-content">
        <h1>ÿÆÿ±Ÿäÿ∑ÿ© ŸÖÿµÿßŸÜÿπ ÿßŸÑŸÖÿ¨ŸÖÿπ ÿßŸÑŸÉŸäŸÖŸäÿßÿ¶Ÿä ÿßŸÑÿ™ŸàŸÜÿ≥Ÿä ÿ®ŸÇÿßÿ®ÿ≥</h1>
        <span class="subtitle">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿµŸÜÿßÿπŸäÿ© ÿ®ÿ∫ŸÜŸàÿ¥ ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ 4 ŸÖÿµÿßŸÜÿπ ÿ™ÿßÿ®ÿπÿ© ŸÑŸÑŸÖÿ¨ŸÖÿπ ÿßŸÑŸÉŸäŸÖŸäÿßÿ¶Ÿä ÿßŸÑÿ™ŸàŸÜÿ≥Ÿä</span>
        <div class="interaction-hint">
          üëÜ ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£Ÿä ŸÖÿµŸÜÿπ ŸÑŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
        </div>
      </div>
    </div>
    
    <div class="map-container">
      <div class="loading-indicator" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <div>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿÆÿ±Ÿäÿ∑ÿ© ŸÇÿßÿ®ÿ≥...</div>
      </div>
      
      <div class="map-controls">
        <div class="control-button active" onclick="toggleLayer('satellite')">
          <i class="fas fa-satellite"></i>ŸÇŸÖÿ± ÿµŸÜÿßÿπŸä
        </div>
        <div class="control-button" onclick="toggleLayer('streets')">
          <i class="fas fa-road"></i>ÿ¥Ÿàÿßÿ±ÿπ
        </div>
        <div class="control-button" onclick="focusOnComplex()">
          <i class="fas fa-crosshairs"></i>ÿßŸÑŸÖÿ¨ŸÖÿπ
        </div>
      </div>
      <div id="map"></div>
    </div>
    
    <div class="map-footer">
 ÿßŸÑŸÖÿ¨ŸÖÿπ ÿßŸÑŸÉŸäŸÖŸäÿßÿ¶Ÿä ÿßŸÑÿ™ŸàŸÜÿ≥Ÿä ‚Äî ŸÉÿ¥ŸÅ ŸÖŸäÿØŸäÿß.
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  
  <script>
    let map;
    let currentLayer = 'satellite';
    let factoryMarkers = [];
    let gabesBounds;
    
    const factories = [
      {
        id: 'icm',
        name: 'ŸÖÿµŸÜÿπ ÿßŸÑÿ≠ÿßŸÖÿ∂ ÿßŸÑŸÅÿ≥ŸÅŸàÿ±Ÿä ÿ®ŸÇÿßÿ®ÿ≥ ICM 1,2,3',
        year: '1972-1974-1982',
        lat: 33.9200,
        lng: 10.0933,
        production: [
          { material: 'ÿßŸÑÿ≠ÿßŸÖÿ∂ ÿßŸÑŸÅÿ≥ŸÅŸàÿ±Ÿä', capacity: '470 ÿ£ŸÑŸÅ ÿ∑ŸÜ/ÿ≥ŸÜÿ©' },
          { material: 'ÿßŸÑŸÅÿ≥ŸÅÿßÿ∑ ÿßŸÑÿπŸÑŸÅŸä', capacity: '120 ÿ£ŸÑŸÅ ÿ∑ŸÜ/ÿ≥ŸÜÿ©' }
        ]
      },
      {
        id: 'dap-a',
        name: 'ŸÖÿµŸÜÿπ ÿßŸÑÿØÿßÿ® (ÿ£) ÿ®ŸÇÿßÿ®ÿ≥',
        year: '1979',
        lat: 33.9158,
        lng: 10.0947,
        production: [
          { material: 'ÿßŸÑÿ≠ÿßŸÖÿ∂ ÿßŸÑŸÅÿ≥ŸÅŸàÿ±Ÿä', capacity: '330 ÿ£ŸÑŸÅ ÿ∑ŸÜ/ÿ≥ŸÜÿ©' },
          { material: 'ÿ´ÿßŸÜŸä ŸÅÿ≥ŸÅÿßÿ∑ ÿßŸÑÿ£ŸÖŸàŸÜŸäÿß', capacity: '650 ÿ£ŸÑŸÅ ÿ∑ŸÜ/ÿ≥ŸÜÿ©' }
        ]
      },
      {
        id: 'dap-b',
        name: 'ŸÖÿµŸÜÿπ ÿßŸÑÿØÿßÿ® (ÿ®) ÿ®ŸÇÿßÿ®ÿ≥',
        year: '1985',
        lat: 33.9153,
        lng: 10.0947,
        production: [
          { material: 'ÿ´ÿßŸÜŸä ŸÅÿ≥ŸÅÿßÿ∑ ÿßŸÑÿ£ŸÖŸàŸÜŸäÿß', capacity: '650 ÿ£ŸÑŸÅ ÿ∑ŸÜ/ÿ≥ŸÜÿ©' }
        ]
      },
      {
        id: 'ammoniter',
        name: 'ŸÖÿµŸÜÿπ ÿßŸÑÿ£ŸÖŸàŸÜŸäÿ™ÿ± ÿ®ŸÇÿßÿ®ÿ≥',
        year: '1983',
        lat: 33.9167,
        lng: 10.0975,
        production: [
          { material: 'ÿßŸÑÿ£ŸÖŸàŸÜŸäÿ™ÿ± ÿßŸÑÿ≤ÿ±ÿßÿπŸä', capacity: '330 ÿ£ŸÑŸÅ ÿ∑ŸÜ/ÿ≥ŸÜÿ©' },
          { material: 'ÿßŸÑÿ£ŸÖŸàŸÜŸäÿ™ÿ± ÿßŸÑŸÜŸÇŸä', capacity: '30 ÿ£ŸÑŸÅ ÿ∑ŸÜ/ÿ≥ŸÜÿ©' }
        ]
      }
    ];

    function initMap() {
      const gctCenter = [33.9175, 10.0950];
      gabesBounds = L.latLngBounds([
        [33.85, 10.05],
        [33.95, 10.15]
      ]);
      
      map = L.map('map', {
        center: gctCenter,
        zoom: window.innerWidth <= 768 ? 14 : 15,
        zoomControl: true,
        scrollWheelZoom: true,
        dragging: true,
        tap: true,
        touchZoom: true,
        maxBounds: gabesBounds,
        maxBoundsViscosity: 1.0,
        minZoom: window.innerWidth <= 768 ? 12 : 13,
        maxZoom: 18
      });

      const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: window.innerWidth <= 768 ? '' : 'Esri, Maxar, GeoEye',
        maxZoom: 18,
        minZoom: window.innerWidth <= 768 ? 12 : 13
      });

      const streetsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: window.innerWidth <= 768 ? '' : 'OpenStreetMap contributors',
        maxZoom: 18,
        minZoom: window.innerWidth <= 768 ? 12 : 13
      });

      satelliteLayer.addTo(map);
      window.mapLayers = {
        satellite: satelliteLayer,
        streets: streetsLayer
      };

      addFactoriesToMap();
      addIndustrialArea();

      map.on('drag', function() {
        map.panInsideBounds(gabesBounds, { animate: false });
      });

      map.on('zoomend', function() {
        if (!gabesBounds.contains(map.getCenter())) {
          map.panTo(gctCenter);
        }
      });

      setTimeout(() => {
        document.getElementById('loadingIndicator').style.display = 'none';
      }, 1200);

      if (window.innerWidth <= 768) {
        map.attributionControl.remove();
      }
    }

    function addFactoriesToMap() {
      factories.forEach((factory, index) => {
        const markerSize = window.innerWidth <= 480 ? 44 : window.innerWidth <= 768 ? 50 : 60;
        const fontSize = window.innerWidth <= 480 ? 16 : window.innerWidth <= 768 ? 18 : 22;
        
        const markerHtml = `<div class="factory-marker-custom" style="width:${markerSize}px; height:${markerSize}px; font-size:${fontSize}px;">${index + 1}</div>`;
        
        const customIcon = L.divIcon({
          html: markerHtml,
          className: 'custom-div-icon',
          iconSize: [markerSize, markerSize],
          iconAnchor: [markerSize/2, markerSize/2],
          popupAnchor: [0, -markerSize/2]
        });

        const marker = L.marker([factory.lat, factory.lng], { icon: customIcon });
        const popupContent = createPopupContent(factory);
        
        marker.bindPopup(popupContent, {
          maxWidth: window.innerWidth <= 480 ? 280 : window.innerWidth <= 768 ? 320 : 400,
          className: 'custom-popup',
          closeButton: true,
          autoPan: true
        });

        marker.addTo(map);
        factoryMarkers.push(marker);

        marker.on('click', function() {
          this.openPopup();
        });
      });
    }

    function createPopupContent(factory) {
      let productionHtml = '';
      factory.production.forEach(item => {
        productionHtml += `
          <div class="production-item">
            <div class="item-header">
              <span class="material-name">${item.material}</span>
              <span class="capacity">${item.capacity}</span>
            </div>
          </div>
        `;
      });

      return `
        <div class="factory-popup">
          <div class="popup-header">
            <div class="popup-icon">üè≠</div>
            <div class="factory-year">${factory.year}</div>
            <div class="factory-name">${factory.name}</div>
            <div class="factory-subtitle">ÿ∑ÿßŸÇÿ© ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨ ŸàÿßŸÑŸÖŸàÿßÿØ ÿßŸÑŸÖÿµŸÜÿπÿ©</div>
          </div>
          <div class="popup-content">
            <div class="production-section">
              <div class="production-title">üìä ÿ™ŸÅÿµŸäŸÑ ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨</div>
              ${productionHtml}
            </div>
          </div>
        </div>
      `;
    }

    function addIndustrialArea() {
      const industrialAreaCoords = [
        [33.9230, 10.0900],
        [33.9230, 10.1000],
        [33.9130, 10.1000],
        [33.9130, 10.0900],
        [33.9230, 10.0900]
      ];

      const industrialArea = L.polygon(industrialAreaCoords, {
        color: '#3498db',
        fillColor: '#3498db',
        fillOpacity: 0.15,
        weight: 3,
        opacity: 0.8,
        dashArray: '10, 5'
      }).addTo(map);
    }

    function toggleLayer(layerType) {
      document.querySelectorAll('.control-button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      if (layerType !== currentLayer) {
        map.removeLayer(window.mapLayers[currentLayer]);
        map.addLayer(window.mapLayers[layerType]);
        currentLayer = layerType;
      }
    }

    function focusOnComplex() {
      map.setView([33.9175, 10.0950], window.innerWidth <= 768 ? 15 : 16);
    }

    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initMap, 200);

      function handleResize() {
        if (map) {
          setTimeout(() => {
            map.invalidateSize();
            if (window.innerWidth <= 768) {
              map.setView([33.9175, 10.0950], 14);
            }
          }, 250);
        }
      }

      window.addEventListener('resize', handleResize);
      window.addEventListener('orientationchange', handleResize);

      if (window.innerWidth <= 768) {
        document.addEventListener('touchstart', function(e) {
          if (e.touches.length > 1) {
            e.preventDefault();
          }
        });
      }
    });
  </script>
</body>
</html>
